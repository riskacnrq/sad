var S=Object.defineProperty;var u=(s,r)=>S(s,"name",{value:r,configurable:!0});import{fileURLToPath as E}from"url";import R from"path";var V=u(()=>E(import.meta.url),"getFilename"),N=u(()=>R.dirname(V()),"getDirname"),d=N();import x from"node-fetch";import*as T from"cheerio";import W from"node:http";import _ from"node:https";var f=class{constructor(r,i,o,t,e,a,n,h,c,p,w,b,v,M,k){this.id=r,this.uniqueId=i,this.nickname=o,this.avatar=t,this.signature=e,this.createdAt=a,this.verified=n,this.secretUID=h,this.bioLink=c,this.privateAccount=p,this.isUnderAge18=w,this.followers=b,this.following=v,this.hearts=M,this.videos=k}};u(f,"User");var A=class{constructor(r,i,o,t,e,a,n,h,c,p){this.author=r,this.video=i,this.audio=o,this.shareCount=t,this.likesCount=e,this.commentCount=a,this.playCount=n,this.createdAt=h,this.tiktokLink=c,this.thumbnail=p}};u(A,"TikTokResult");var g=class{constructor(r,i,o,t,e,a,n,h,c,p,w,b,v,M,k,L,$){this.id=r,this.description=i,this.createdAt=o,this.height=t,this.width=e,this.duration=a,this.resolution=n,this.shareCount=h,this.likesCount=c,this.commentCount=p,this.playCount=w,this.downloadURL=b,this.cover=v,this.dynamicCover=M,this.playURL=k,this.format=L,this.author=$}};u(g,"Video");var I=class{constructor(r,i,o,t,e,a,n,h,c){this.id=r,this.title=i,this.playURL=o,this.coverLarge=t,this.coverThumb=e,this.author=a,this.duration=n,this.original=h,this.album=c}};u(I,"Music");import{createWriteStream as C,existsSync as y,mkdirSync as O,unlinkSync as q}from"node:fs";import{exit as D}from"node:process";import U from"miniget";var l=class{async requestWebsite(r,i){let o=new W.Agent({keepAlive:!0,maxSockets:20}),t=new _.Agent({keepAlive:!0,maxSockets:20}),e={agent:c=>c.protocol=="http:"?o:t,headers:{"User-Agent":"Mozilla/5.0 (Windows NT 10.0; Win64; x64) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/97.0.4692.71 Safari/537.36 Edg/97.0.1072.62"}},n=await(await x(`${r}`,i||e)).text();return T.load(n,{xmlMode:!0})}handleHTMLContent(r){let i=r,o=i.split("window['SIGI_STATE']=")[1].indexOf(";window['SIGI_RETRY']=");return JSON.parse(i.split("window['SIGI_STATE']=")[1].slice(0,o))}async video(r){if(!r)throw new Error("A video URL must be provided");let o=(await this.requestWebsite(r))("#SIGI_STATE").text(),t=JSON.parse(o),e=t.ItemList.video.list[0];return new g(t.ItemModule[e].video.id,t.ItemModule[e].desc,new Date(Number(t.ItemModule[e].createTime)*1e3).toLocaleDateString(),Number(t.ItemModule[e].video.height),Number(t.ItemModule[e].video.width),Number(t.ItemModule[e].video.duration),t.ItemModule[e].video.ratio,t.ItemModule[e].stats.shareCount,t.ItemModule[e].stats.diggCount,t.ItemModule[e].stats.commentCount,t.ItemModule[e].stats.playCount,t.ItemModule[e].video.downloadAddr.trim(),t.ItemModule[e].video.cover,t.ItemModule[e].video.dynamicCover,t.ItemModule[e].video.playAddr.trim(),t.ItemModule[e].video.format,t.ItemModule[e].nickname)}async user(r){if(!r)throw new Error("Please enter a username");let o=(await this.requestWebsite(`https://www.tiktok.com/@${r}`))("#SIGI_STATE").text(),t=JSON.parse(o),e=t.UserModule.users[r];return new f(e.id,e.uniqueId,e.nickname,e.avatarLarger,e.signature.trim(),new Date(e.createTime*1e3).toLocaleDateString(),e.verified,e.secUid,e?.bioLink?.link,e.privateAccount,e.isUnderAge18,t.UserModule.stats[r].followerCount,t.UserModule.stats[r].followingCount,t.UserModule.stats[r].heart,t.UserModule.stats[r].videoCount)}async getAllVideosFromUser(r){if(!r)throw new Error("You must provide a username!");let o=(await this.requestWebsite(`https://www.tiktok.com/@${r}`))("#SIGI_STATE").text(),t=JSON.parse(o),e=[],{ItemList:a}=t;return a["user-post"].list.forEach(n=>{e.push(new g(t.ItemModule[n].video.id,t.ItemModule[n].desc,new Date(Number(t.ItemModule[n].createTime)*1e3).toLocaleDateString(),Number(t.ItemModule[n].video.height),Number(t.ItemModule[n].video.width),Number(t.ItemModule[n].video.duration),t.ItemModule[n].video.ratio,t.ItemModule[n].stats.shareCount,t.ItemModule[n].stats.diggCount,t.ItemModule[n].stats.commentCount,t.ItemModule[n].stats.playCount,t.ItemModule[n].video.downloadAddr.trim(),t.ItemModule[n].video.cover,t.ItemModule[n].video.dynamicCover,t.ItemModule[n].video.playAddr.trim(),t.ItemModule[n].video.format))}),e}async getMusic(r){if(!r)throw new Error("You must provide a link!");let o=(await this.requestWebsite(r))("#SIGI_STATE").text(),t=JSON.parse(o),e=t.ItemList.video.list[0];return new I(t.ItemModule[e].music.id,t.ItemModule[e].music.title,t.ItemModule[e].music.playUrl,t.ItemModule[e].music.coverLarge,t.ItemModule[e].music.coverThumb,t.ItemModule[e].music.authorName,Number(t.ItemModule[e].music.duration),t.ItemModule[e].music.original,t.ItemModule[e].music.album)}async downloadAllVideosFromUser(r,i){if(!r)throw new Error("Please enter a username!");let o=await this.getAllVideosFromUser(r);if(!o)throw new Error("No Videos were found for this username. Either the videos are private or the user has not videos");if(!i.path){if(i.path=`${d}/../${r}`,y(i.path)){console.log("A folder with this username exists, that is unusual!");try{q(i.path)}catch(t){console.log(`[ERROR] Could not remove ${i.path}
 Error Message: ${t.message}`),D(1)}}y(i.path)||O(i.path)}if(!i.watermark){for(let[t,e]of o.entries()){console.log(`Downloading Video: ${e.description?e.description:e.id}, [${t+1}/${o.length}]`);let a=await this.noWaterMark(e.id);if(!a){console.log(`Could not fetch ${e.description?e.description:e.id} with no watermark`);continue}U(a).pipe(C(`${i.path}/${e.id}_${e.resolution}.${e.format}`))}return}for(let[t,e]of o.entries())console.log(`Downloading Video: ${e.description?e.description:e.id}, [${t+1}/${o.length}]`),U(e.downloadURL).pipe(C(`${i.path}/${e.id}_${e.resolution}.${e.format}`))}async noWaterMark(r){let i="";r.startsWith("https")?i=(await this.video(r)).id:i=r;let t=await(await x("https://api2.musical.ly/aweme/v1/aweme/detail/?aweme_id="+i)).json();if(!t)throw new Error("There was an Error retrieveing this video without watermark!");let e=t.aweme_detail.video.download_addr.uri;if(!e)throw new Error("There was an Error retrieveing this video without watermark!");return`https://api-h2.tiktokv.com/aweme/v1/play/?video_id=${e}`}};u(l,"TTScraper");async function Ae(s){if(!s)throw new Error("You must provide a Tiktok video url!");return await new l().video(s)}u(Ae,"fetchVideo");async function xe(s){if(!s)throw new Error("You must provide a username!");return await new l().user(s)}u(xe,"fetchUser");async function Ce(s){if(!s)throw new Error("You must provide a username!");return await new l().getAllVideosFromUser(s)}u(Ce,"fetchAllVideosFromUser");async function ye(s){if(!s)throw new Error("You must provide a Tiktok video url!");return await new l().getMusic(s)}u(ye,"fetchMusic");async function Ue(s){if(!s)throw new Error("You must provide a Tiktok video url!");return await new l().noWaterMark(s)}u(Ue,"fetchVideoNoWaterMark");export{I as Music,l as TTScraper,A as TikTokResult,f as User,g as Video,Ce as fetchAllVideosFromUser,ye as fetchMusic,xe as fetchUser,Ae as fetchVideo,Ue as fetchVideoNoWaterMark};
